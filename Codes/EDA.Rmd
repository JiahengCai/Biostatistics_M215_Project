---
title: "EDA"
author: "Jiaheng Cai"
date: "11/16/2021"
output: 
  html_document:
    highlight: pygments
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

System information
```{r}
library(tidyverse)
library(readxl)
library(gtsummary)
library(survival)
library(survminer)

os <- sessionInfo()$running

if (str_detect(os, "Ubuntu")) {
  path <- '~/Biostatistics_M215_Project/data/'
} else if (str_detect(os, "mac")) {
  path <- '~/Downloads/Biostat 215 Project/Biostatistics_M215_Project/Data/'
} else if(str_detect(os, "Windows")){
  path <- "C:/Users/alexc/Desktop/215/Biostats-M215/"
}
```
Data clean and recode
```{r}
endpoint = read_excel(paste0(path, 'endpoints.xls'))
endpoint_colnames = c('ID', 'Intervention Group', 
                      'Vitality Status as of 6/1/2006', 
                      'Breast Cancer Status as of 6/1/2006 or last prior contact',
                      'Other Cancer (invasive, not breast) Status as of 6/1/2006',
                      'Breast Cancer Contribute to Death',
                      'Year Breast Cancer Diagnosed', 'Cancer Grade',
                      'Dummy Variable for Cancer Grade 2', 
                      'Dummy Variable for Cancer Grade 3',
                      'Dummy Variable for Unknown Cancer Grade',
                      'Cancer Stage, AJCC 6th', 
                      'Dummy Variable for Stage 2 AJCC 6th',
                      'Dummy Variable for Stage 3 AJCC 6th',
                      'WHEL Clinical Site', 'Recurrence Flag',
                      'Years from Diagnosis to WHEL Study Entry',
                      'Years from Study Entry to Recurrence/New Primary, or to Censor',
                      'Years from Diagnosis to Recurrence/New Primary, or to Censor',
                      'Years from Diagnosis to Death or Censor')

colnames(endpoint) = endpoint_colnames

endpoint$`Intervention Group` = ifelse(endpoint$`Intervention Group` == 3, 'Intervention', 'Comparison')

endpoint$`Vitality Status as of 6/1/2006` = ifelse(endpoint$`Vitality Status as of 6/1/2006` == 0, 'Dead', ifelse(endpoint$`Vitality Status as of 6/1/2006` == 1, 'Alive', 'Unknown'))

for (i in 1:nrow(endpoint)){
if (endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] == 0){
  endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] = 'No Evidence of Recurrence'
} else if(endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] == 1){
  endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] = 'Confirmed – New Primary Breast Cancer'
}else if(endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] == 2){
  endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] = 'Confirmed – Local Recurrence'
}else if(endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] == 3){
  endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] = 'Confirmed – Regional Recurrence'
}else{
  endpoint$`Breast Cancer Status as of 6/1/2006 or last prior contact`[i] = 'Confirmed – Distant Recurrence	'}
}

endpoint$`Other Cancer (invasive, not breast) Status as of 6/1/2006` = ifelse(endpoint$`Other Cancer (invasive, not breast) Status as of 6/1/2006` == 0, 'No evidence of Disease', ifelse(endpoint$`Other Cancer (invasive, not breast) Status as of 6/1/2006` == 1, 'Reported Other Cancer (not confirmed)', 'Confirmed Other Cancer'))

endpoint$`Breast Cancer Contribute to Death`[endpoint$`Breast Cancer Contribute to Death` == -1] = 'Not Dead'
endpoint$`Breast Cancer Contribute to Death`[endpoint$`Breast Cancer Contribute to Death` == 0] = 'Dead from a cause other than Breast Cancer'
endpoint$`Breast Cancer Contribute to Death`[endpoint$`Breast Cancer Contribute to Death` == 1] = 'Dead from Breast Cancer'
endpoint$`Breast Cancer Contribute to Death`[endpoint$`Breast Cancer Contribute to Death` == 2] = 'Dead from Cancer, not confirmed breast but likely so'

endpoint$`Cancer Grade`[endpoint$`Cancer Grade` == 0] = 'Grade Not Applicable or Not Available'
endpoint$`Cancer Grade`[endpoint$`Cancer Grade` == 1] = 'Grade I, Well Differentiated'
endpoint$`Cancer Grade`[endpoint$`Cancer Grade` == 2] = 'Grade II, Moderately Differentiated'
endpoint$`Cancer Grade`[endpoint$`Cancer Grade` == 3] = 'Grade III, Poorly Differentiated'

endpoint$`Cancer Stage, AJCC 6th`[endpoint$`Cancer Stage, AJCC 6th` == 1] = 'Stage I'
endpoint$`Cancer Stage, AJCC 6th`[endpoint$`Cancer Stage, AJCC 6th` == 2] = 'Stage IIA'
endpoint$`Cancer Stage, AJCC 6th`[endpoint$`Cancer Stage, AJCC 6th` == 3] = 'Stage IIB'
endpoint$`Cancer Stage, AJCC 6th`[endpoint$`Cancer Stage, AJCC 6th` == 4] = 'Stage IIIA'
endpoint$`Cancer Stage, AJCC 6th`[endpoint$`Cancer Stage, AJCC 6th` == 5] = 'Stage IIIB'

endpoint$`WHEL Clinical Site`[endpoint$`WHEL Clinical Site` == 1] = 'Site A in California'
endpoint$`WHEL Clinical Site`[endpoint$`WHEL Clinical Site` == 3] = 'Site B in California'
endpoint$`WHEL Clinical Site`[endpoint$`WHEL Clinical Site` == 5] = 'Site C in California'
endpoint$`WHEL Clinical Site`[endpoint$`WHEL Clinical Site` == 7] = 'Site in Arizona'
endpoint$`WHEL Clinical Site`[endpoint$`WHEL Clinical Site` == 9] = 'Site D in California'
endpoint$`WHEL Clinical Site`[endpoint$`WHEL Clinical Site` == 11] = 'Site in Texas'
endpoint$`WHEL Clinical Site`[endpoint$`WHEL Clinical Site` == 13] = 'Site in Oregon'

endpoint$`Recurrence Flag`[endpoint$`Recurrence Flag` == 0] = 'No Invasive Breast Cancer Events'
endpoint$`Recurrence Flag`[endpoint$`Recurrence Flag` == 1] = 'Invasive Breast Cancer Event'
```

# Baseline Characteristics of WHEL Study Participants by Study Group
```{r}
endpoint %>%
  tbl_summary(by = 'Intervention Group',
              include=-c(ID, `Year Breast Cancer Diagnosed`,
                         `Dummy Variable for Cancer Grade 2`,
                         `Dummy Variable for Cancer Grade 3`,
                         `Dummy Variable for Unknown Cancer Grade`,
                         `Dummy Variable for Stage 2 AJCC 6th`,
                         `Dummy Variable for Stage 3 AJCC 6th`),
              missing_text = "Missing") %>%
  add_p()
```

# Table 5 Intervention Effects on All-Cause Mortality by Baseline Demographic and Clinical Characteristics

## Preprocessing
```{r}
demo = read_excel("../Data/demographics.xls")
phbase = read_excel("../Data/phbase.xls")
nds = read_excel("../Data/ndsfoody4.xls")
medical = read_excel("../Data/Medical.xls")

# We need the following variables:

## Survival time
SurvTime = as.numeric(endpoint$`Years from Diagnosis to Death or Censor`)
## Group and Status
Group = as_factor(endpoint$`Intervention Group`)
Group = relevel(Group, ref = "Comparison")
a = as_factor(endpoint$`Vitality Status as of 6/1/2006`)
Status = ifelse(a == "Alive", 0, 1)
## Age at randomization, y
AgeIdx = ifelse(demo$`age at rand` < 55, "<55", ">=55") # Age indicator (<=55 or not)
## Cancer stage at diagnosis
a = endpoint$`Cancer Stage, AJCC 6th`
CancerStage = as_factor(a)
## Hormone receptor status
a = medical$`Estr Recep`
b = medical$`Prog Recep`
HormoneRecep = ifelse(a==1 & b==1, "ER+/PR+",
                      ifelse(a==1 & b==0, "ER+/PR-",
                             ifelse(a==0 & b==1, "ER-/PR+",
                                    ifelse(a==0 & b==0, "ER-/PR-", NA))))
## Time from Diag to Rand
a = endpoint$`Years from Diagnosis to WHEL Study Entry`
TimeDiagRand = as.numeric(ifelse(a <=1, 0,
                        ifelse(a <=2, 1,
                               ifelse(a <=3, 2, 3
                        )))) # Time from diagnosis to randomization
## Tumor differentiation
a = endpoint$`Cancer Grade`
TumorDiff = as_factor(a)
## No. of positive nodes (Number axillary lymph nodes positive)
a = medical$`Node Pos`
PosNodes = ifelse(a==0, 0, 
                  ifelse(a < 3, 1,
                         ifelse(a < 6, 2, 3)))
## Tumor size
a = medical$`Tumor Size` 
TumorSize = ifelse(a < 2, 0, 
                   ifelse(a < 3, 1,
                          ifelse(a < 4, 2,
                                 ifelse(a < 5, 3, 4))))
## Physical activity 
a = phbase$`NEW METS` 
PhysicalAct = ifelse(a <= 210, "<210", 
                      ifelse(a <= 615, "211~615",
                             ifelse(a <= 1290, "616~1290", ">1290"))) 
## Energy intake
b = matrix(NA, nrow = length(a), ncol=1)
colnames(b) = "KCal"
b[endpoint$ID %in% nds$ID] = nds$Kcal
KCal = as_factor(ifelse(b <= 1430, "<1430",
              ifelse(b <= 1680, "1430~1680",
                     ifelse(b <= 1980, "1681~1980", 
                            ifelse(b > 1980, ">1980", NA)))))


##### PUT THEM TOGETHER #####
AllCauseMortalityData = data.frame(
  SurvTime, Group, Status, AgeIdx, CancerStage, HormoneRecep, TimeDiagRand,
        TumorDiff, PosNodes, TumorSize, PhysicalAct, KCal
)
#############################
```

## Universal and univariable Cox regression
```{r}
coxph(Surv(SurvTime, Status) ~ ., data=AllCauseMortalityData)

library(sjPlot)
library(sjmisc)
library(sjlabelled)

# Standard table
tab_model(coxph(Surv(SurvTime, Status) ~ ., data=AllCauseMortalityData))
```

```{R}
library(survival)
library(finalfit)
dependent_os <- "Surv(SurvTime, Status)"
explanatory <- c("AgeIdx", "CancerStage", "HormoneRecep", "TimeDiagRand",
        "TumorDiff", "PosNodes", "TumorSize", "PhysicalAct", "KCal")
AllCauseMortalityData %>%
  filter(Group=="Intervention") %>%
  finalfit(dependent_os, explanatory)
```

## Imputation
```{R}
library(miceRanger)
ImputedAll <- AllCauseMortalityData %>%
  miceRanger(
  m = 3, 
  returnModels = TRUE,
  verbose = TRUE
)
```
### Quality Check
```{r}
plotModelError(ImputedAll, vars = 'allNumeric')
plotDistributions(ImputedAll, vars = 'allNumeric')
plotVarImportance(ImputedAll)
```

## Cox Regression for each variable
```{r}
ImputedData = as.data.frame(completeData(ImputedAll)[[3]])
for (item in explanatory) {
  len = ImputedData %>%
    select(item) %>%
    unique(.) %>%
    nrow(.)
  category = ImputedData %>%
      select(item) %>%
      unique(.)
  hi = item
  for (i in 1:len) {
    cat = category[i,]
    print(paste0("Explanatory: ", hi))
    print(paste0("Category: ", cat))
    idx = ImputedData[, hi] == cat
    print(summary(coxph(Surv(SurvTime, Status) ~ Group, data=ImputedData[idx, ])))
  }
}
```

## Competing Risk Model



